<div class="container mx-auto">
    <app-toolbar [pageTitle]="title"
                 [breadcrumbs]="[
                    { title: 'Trang chủ' },
                    { title: 'Danh sách HĐ bảo vệ' },
                    { title: title },
                 ]">
        <div class="flex items-center gap-2">
            <button nz-button nzType="dashed" nzSize="large"
                    class="w-[100px]"
                    [routerLink]="['/' + urlExaminerCouncil]"
                    [disabled]="isLoading$ | async">
                Trở lại
            </button>
            <button nz-button nzType="primary" nzSize="large"
                    class="w-[100px]"
                    [disabled]="!groups.length || (isLoading$ | async)"
                    (click)="onSave()">
                Lưu
            </button>
        </div>
    </app-toolbar>
    <nz-spin [nzSpinning]="isLoading$ | async">
        <div class="flex gap-8">
            <div class="w-1/4">
                <div class="bg-white border border-gray-150 shadow rounded-md overflow-hidden">
                    <div class="flex justify-between items-center min-h-[70px] px-6 lg:px-8">
                        <div class="font-semibold text-xl">
                            Thông tin chung
                        </div>
                    </div>
                    <div class="px-6 lg:px-8 mb-6">
                        <app-form #form>
                            <div class="flex flex-col gap-4">
                                <app-form-select control="departmentId" label="Khoa"
                                                 selectValue="id" selectLabel="name"
                                                 [options]="departments$ | async"
                                                 [allowClear]="false"
                                                 [validators]="{ required: true }"/>
                                <app-form-select control="semesterId" label="Học kì"
                                                 selectValue="id" selectLabel="name"
                                                 [options]="semesters$ | async"
                                                 [allowClear]="false"
                                                 [validators]="{ required: true }"/>
                            </div>
                        </app-form>
                        <button class="mt-4" nzSize="large"
                                nzBlock nz-button nzType="primary"
                                [disabled]="(form.getValue('departmentId') === currentDepartment
                                && form.getValue('semesterId') === currentSemester)"
                                (click)="onLoadingProjects(form.form)">
                            Kiểm tra danh sách đồ án
                        </button>
                    </div>
                </div>
            </div>
            <div class="w-3/4 flex flex-col gap-6">
                <div class="bg-white border border-gray-150 shadow rounded-md overflow-hidden"
                     *ngFor="let group of groups; let index = index;">
                    <div class="flex justify-between items-center min-h-[70px] px-6 lg:px-8">
                        <div class="flex gap-2 items-center">
                            <div class="text-lg font-semibold text-gray-600 border-r border-gray-150 pr-2">
                                Hội đồng {{ index < 10 ? '0' + (index + 1) : (index + 1) }}
                            </div>
                            <div class="flex items-center gap-2">
                                <ng-container *ngIf="editLocationId === index; else noEditLocationTmpl">
                                    <nz-input-group [nzSuffix]="suffixIconSearch">
                                        <input type="text" nz-input placeholder="Địa điểm"
                                               (keyup.enter)="editLocationId = null"
                                               (blur)="editLocationId = null"
                                               [(ngModel)]="group.location"/>
                                    </nz-input-group>
                                    <ng-template #suffixIconSearch>
                                        <i (click)="editLocationId = null" class='bx bx-check cursor-pointer'></i>
                                    </ng-template>
                                </ng-container>
                                <ng-template #noEditLocationTmpl>
                                    <span [class.italic]="!group.location"
                                          [class.text-gray-400]="!group.location">
                                        {{ group.location || '(Vui lòng nhập địa điểm)' }}
                                    </span>
                                    <i (click)="editLocationId = index" class='cursor-pointer text-blue-500 bx bx-edit-alt'></i>
                                </ng-template>
                            </div>
                        </div>
                        <div class="flex gap-2 items-center">
                            <button *ngIf="index > 0" (click)="onRemoveGroup(index)" class="flex items-center justify-center gap-1" nz-button nzType="primary" nzDanger nzSize="default">
                                <i class='bx bxs-trash-alt'></i>
                                Xoá
                            </button>
                        </div>
                    </div>
                    <div class="px-6 py-1.5 bg-[#F5F5F5] font-semibold border-b border-gray-100 flex items-center justify-between gap-2">
                        Danh sách thành viên
                        <button nz-button nzType="primary" nzSize="default" (click)="onSearchUser(index)">
                            Chọn thành viên
                        </button>
                    </div>
                    <div class="border-t border-gray-150">
                        <app-table [data]="group.users" size="small">
                            <app-table-column key="user.fullName" title="Họ và tên" width="250px"/>
                            <app-table-column key="position" title="Chức vụ" width="150px">
                                <ng-template table-cell let-row>
                                    <div class="editable-cell" [hidden]="editId === row.userId" (click)="editId = row.userId">
                                        {{ row?.position | councilPosition }}
                                    </div>
                                    <nz-select class="w-full" [(ngModel)]="row.position" [hidden]="editId !== row.userId" (ngModelChange)="editId = null">
                                        <nz-option *ngFor="let position of positions"
                                                   [nzValue]="position.value" [nzLabel]="position.label"
                                        ></nz-option>
                                    </nz-select>
                                </ng-template>
                            </app-table-column>
                            <app-table-column key="action" title="Hành động" align="center" width="100px">
                                <ng-template table-cell let-row>
                                    <i (click)="onRemoveUser(index, row.userId!)" class='text-red-600 cursor-pointer bx bxs-trash-alt'></i>
                                </ng-template>
                            </app-table-column>
                        </app-table>
                    </div>
                    <div class="px-6 py-1.5 bg-[#F5F5F5] font-semibold border-b border-gray-100 flex items-center justify-between gap-2">
                        Danh sách đề tài bảo vệ
                        <button nz-button nzType="primary" nzSize="default" (click)="onSearchProject(index)">
                            Chọn đề tài
                        </button>
                    </div>
                    <div class="border-t border-gray-150">
                        <app-table [data]="group.projects" size="small">
                            <app-table-column key="students" title="Sinh viên thực hiện" width="250px">
                                <ng-template table-cell let-row>
                                    <div *ngFor="let student of row.students">
                                        {{ student.code }} - {{ student.fullName }}
                                    </div>
                                </ng-template>
                            </app-table-column>
                            <app-table-column key="name" title="Tên đề tài" width="250px"/>
                            <app-table-column key="instructor.fullName" title="GV hướng dẫn" width="200px"/>
                            <app-table-column key="reviewerStaff.user.fullName" title="GV phản biện" width="200px"/>
                            <app-table-column key="action" title="" align="center" width="50px" [right]="true">
                                <ng-template table-cell let-row>
                                    <i (click)="onRemoveProject(index, row.id!)" class='text-red-600 cursor-pointer bx bxs-trash-alt'></i>
                                </ng-template>
                            </app-table-column>
                        </app-table>
                    </div>
                </div>

                <div class="flex justify-end" *ngIf="groups.length">
                    <button (click)="onAddGroup()" nzSize="large" nz-button nzType="primary">
                        Thêm nhóm
                    </button>
                </div>
            </div>
        </div>
    </nz-spin>

</div>

<ng-template #confirmContent let-params let-ref="modalRef">
    <div class="flex flex-col gap-4">
        <div class="rounded-md px-4 py-2 border border-blue-300 bg-blue-200">
            Có tất cả {{ (projects$ | async)?.length }} đề tài đủ điều kiện bảo vệ.
        </div>
        <nz-form-item>
            <nz-form-label [nzSpan]="24" nzFor="permission">Hình thức tổ chức</nz-form-label>
            <nz-form-control [nzSpan]="24">
                <nz-radio-group class="grid grid-cols-2 gap-4" [(ngModel)]="params.type">
                    <label class="col-span-1 mr-0 radio-block" [nzValue]="0" nz-radio>Ngẫu nhiên</label>
                    <label class="col-span-1 mr-0 radio-block" [nzValue]="1" nz-radio>Thủ công</label>
                </nz-radio-group>
            </nz-form-control>
        </nz-form-item>

        <nz-form-item *ngIf="!params.type">
            <nz-form-label [nzSpan]="24" nzFor="permission">Số đề tài mỗi nhóm</nz-form-label>
            <nz-form-control [nzSpan]="24">
                <nz-input-number class="w-full" [(ngModel)]="params.projectPerGroup" nzSize="large" [nzMin]="1"></nz-input-number>
            </nz-form-control>
        </nz-form-item>
    </div>

    <div class="grid grid-cols-2 gap-4 mt-4">
        <button nz-button nzType="primary" nzSize="large" (click)="ref.destroy(params)">
            Xác nhận
        </button>
        <button nz-button nzType="default" nzSize="large" (click)="ref.destroy()">
            Trở lại
        </button>
    </div>
</ng-template>

<app-search-user [(isVisible)]="isVisibleSearchUser"
                 [isMultiple]="true"
                 (select)="onSelectUser($event)"
></app-search-user>
<app-search-project [(isVisible)]="isVisibleSearchProject"
                    [isMultiple]="true"
                    [projects]="projects$ | async"
                    [hiddenIds]="hiddenIds"
                    (select)="onSelectProject($event)"
></app-search-project>
